
from pyrogram import Client, filters
from pyrogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from pytube import YouTube
import os

API_ID = 26345223
API_HASH = "2d82aca171ac54b09a103cccb4ba5c7f"
BOT_TOKEN = "8116239967:AAEUXR7rWMAqQxKhdms2wVPF85jNq9H-EY8"

app = Client("youtube_bot", bot_token=BOT_TOKEN, api_id=API_ID, api_hash=API_HASH)

DOWNLOAD_FOLDER = "downloads"
os.makedirs(DOWNLOAD_FOLDER, exist_ok=True)

def get_stream_options(url):
    yt = YouTube(url)
    streams = yt.streams.filter(progressive=True, file_extension="mp4").order_by("resolution").desc()
    audio = yt.streams.filter(only_audio=True).first()
    options = {f"{s.resolution} - {s.fps}fps": s.itag for s in streams}
    if audio:
        options["MP3 - Audio Only"] = audio.itag
    return yt.title, options

@app.on_message(filters.command("start"))
def start(_, msg):
    msg.reply("üîó YouTube linkini g√∂nd…ôr v…ô keyfiyy…ôt se√ß!")

@app.on_message(filters.text & filters.private)
def download_handler(_, msg):
    url = msg.text
    if not url.startswith("http"):
        msg.reply("‚ùå Z…ôhm…ôt olmasa ke√ß…ôrli bir YouTube linki g√∂nd…ôrin.")
        return

    try:
        title, options = get_stream_options(url)
        buttons = [
            [InlineKeyboardButton(text=opt, callback_data=f"{url}|{itag}")]
            for opt, itag in options.items()
        ]
        msg.reply(
            f"üé¨ *{title}*\n\nüì• A≈üaƒüƒ±dakƒ± keyfiyy…ôti se√ß:",
            reply_markup=InlineKeyboardMarkup(buttons),
            parse_mode="markdown"
        )
    except Exception as e:
        msg.reply(f"‚ö†Ô∏è X…ôta ba≈ü verdi: {e}")

@app.on_callback_query()
def callback(_, query):
    url, itag = query.data.split("|")
    yt = YouTube(url)
    stream = yt.streams.get_by_itag(int(itag))

    is_audio = "audio" in stream.mime_type

    msg = query.message.reply("‚è¨ Y√ºkl…ônir, z…ôhm…ôt olmasa g√∂zl…ôyin...")

    try:
        out_file = stream.download(output_path=DOWNLOAD_FOLDER)
        if is_audio:
            mp3_file = out_file.replace(".mp4", ".mp3")
            os.system(f"ffmpeg -i '{out_file}' -vn -ab 192k -ar 44100 -y '{mp3_file}'")
            os.remove(out_file)
            query.message.reply_document(mp3_file, caption="üéß MP3 y√ºkl…ôndi.")
            os.remove(mp3_file)
        else:
            query.message.reply_video(out_file, caption="üé¨ Video y√ºkl…ôndi.")
            os.remove(out_file)

        msg.delete()
    except Exception as e:
        msg.edit(f"‚ùå X…ôta ba≈ü verdi: {e}")

app.run()
